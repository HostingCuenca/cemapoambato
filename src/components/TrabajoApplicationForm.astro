---
// Componente TrabajoApplicationForm
// Este componente maneja el formulario general de aplicación para vacantes
---

<div class="bg-white p-8 rounded-xl shadow-lg border border-gray-100">
    <form id="general-application-form" class="space-y-5">
        <!-- Datos personales -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
            <div>
                <label for="gen-fullName" class="block text-sm font-medium text-gray-700 mb-1">Nombres completos*</label>
                <input type="text" id="gen-fullName" name="fullName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
            </div>
            <div>
                <label for="gen-city" class="block text-sm font-medium text-gray-700 mb-1">Ciudad*</label>
                <input type="text" id="gen-city" name="city" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
            <div>
                <label for="gen-phone" class="block text-sm font-medium text-gray-700 mb-1">Teléfono/WhatsApp*</label>
                <input type="tel" id="gen-phone" name="phone" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="+593 XX XXX XXXX" required>
            </div>
            <div>
                <label for="gen-email" class="block text-sm font-medium text-gray-700 mb-1">Correo electrónico*</label>
                <input type="email" id="gen-email" name="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
            </div>
        </div>

        <!-- Área de interés -->
        <div>
            <label for="gen-area" class="block text-sm font-medium text-gray-700 mb-1">Área de interés*</label>
            <select id="gen-area" name="area" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                <option value="" disabled selected>Seleccione una opción</option>
                <option value="Formación y Capacitación">Formación y Capacitación</option>
                <option value="Desarrollo Organizacional">Desarrollo Organizacional</option>
                <option value="Gestión del Talento">Gestión del Talento</option>
                <option value="Psicología Clínica">Psicología Clínica</option>
                <option value="Tecnología Educativa">Tecnología Educativa</option>
                <option value="Administrativo">Administrativo</option>
                <option value="Otro">Otro</option>
            </select>
        </div>

        <!-- Experiencia -->
        <div>
            <label for="gen-experience" class="block text-sm font-medium text-gray-700 mb-1">Años de experiencia*</label>
            <select id="gen-experience" name="experience" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                <option value="" disabled selected>Seleccione una opción</option>
                <option value="Menos de 1 año">Menos de 1 año</option>
                <option value="1-3 años">1-3 años</option>
                <option value="3-5 años">3-5 años</option>
                <option value="5-10 años">5-10 años</option>
                <option value="Más de 10 años">Más de 10 años</option>
            </select>
        </div>

        <!-- CV -->
        <div>
            <label for="gen-cv" class="block text-sm font-medium text-gray-700 mb-1">Adjuntar CV (PDF, DOC, DOCX)*</label>
            <input type="file" id="gen-cv" name="cv" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" accept=".pdf,.doc,.docx" required>
            <p class="text-xs text-gray-500 mt-1">Tamaño máximo: 5MB</p>
        </div>

        <!-- Mensaje breve -->
        <div>
            <label for="gen-message" class="block text-sm font-medium text-gray-700 mb-1">Mensaje breve (opcional)</label>
            <textarea id="gen-message" name="message" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Cuéntanos brevemente sobre tu experiencia y por qué te gustaría trabajar con nosotros"></textarea>
        </div>

        <!-- Términos -->
        <div class="flex items-start">
            <div class="flex items-center h-5">
                <input id="gen-terms" name="terms" type="checkbox" class="w-4 h-4 border border-gray-300 rounded focus:ring-blue-500" required>
            </div>
            <label for="gen-terms" class="ml-2 text-sm text-gray-700">
                Acepto el tratamiento de mis datos personales para el proceso de selección.
            </label>
        </div>

        <!-- Botones de envío -->
        <div class="flex flex-col sm:flex-row gap-4">
            <button type="submit" id="genSubmitBtnSave" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition-colors duration-300 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>Enviar CV</span>
            </button>

            <button type="button" id="genSubmitBtnWhatsApp" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4 rounded-lg transition-colors duration-300 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.501-.669-.51l-.57-.01c-.198 0-.52.074-.792.372s-1.04 1.016-1.04 2.479 1.065 2.876 1.213 3.074c.149.198 2.095 3.2 5.076 4.487.709.306 1.263.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/>
                </svg>
                <span>Contactar por WhatsApp</span>
            </button>

            <button type="button" id="gen-mailto-btn" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-medium py-3 px-4 rounded-lg transition-colors duration-300 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" />
                </svg>
                <span>Enviar por Email</span>
            </button>
        </div>

        <!-- Mensaje de estado del envío -->
        <div id="gen-form-status" class="hidden py-3 px-4 rounded-lg text-center"></div>
    </form>
</div>

<script is:inline>
    document.addEventListener('DOMContentLoaded', function() {
        // Obtener referencias a los elementos del formulario
        const generalApplicationForm = document.getElementById('general-application-form');
        const genSubmitBtnSave = document.getElementById('genSubmitBtnSave');
        const genSubmitBtnWhatsApp = document.getElementById('genSubmitBtnWhatsApp');
        const genMailtoBtn = document.getElementById('gen-mailto-btn');
        const genFormStatus = document.getElementById('gen-form-status');
        const fullNameInput = document.getElementById('gen-fullName');
        const cityInput = document.getElementById('gen-city');
        const phoneInput = document.getElementById('gen-phone');
        const emailInput = document.getElementById('gen-email');
        const areaSelect = document.getElementById('gen-area');
        const experienceSelect = document.getElementById('gen-experience');
        const messageInput = document.getElementById('gen-message');
        const cvInput = document.getElementById('gen-cv');
        const termsCheckbox = document.getElementById('gen-terms');

        // Verificar que todos los elementos existan
        if (!generalApplicationForm || !genSubmitBtnSave || !genFormStatus) {
            console.error('No se pudieron encontrar todos los elementos del formulario');
            return;
        }

        // Función para actualizar el estado del formulario
        function updateFormStatus(message, isSuccess) {
            genFormStatus.textContent = message;
            genFormStatus.classList.remove('hidden');

            // Resetear clases
            genFormStatus.className = 'py-3 px-4 rounded-lg text-center';

            if (isSuccess === true) {
                genFormStatus.classList.add('bg-green-100');
                genFormStatus.classList.add('text-green-800');
            } else if (isSuccess === false) {
                genFormStatus.classList.add('bg-red-100');
                genFormStatus.classList.add('text-red-800');
            }
        }

        // Configurar envío por WhatsApp
        if (genSubmitBtnWhatsApp) {
            genSubmitBtnWhatsApp.addEventListener('click', function() {
                // Validar formulario
                if (!generalApplicationForm.checkValidity()) {
                    generalApplicationForm.reportValidity();
                    return;
                }

                // Recoger datos del formulario
                const fullName = fullNameInput.value;
                const city = cityInput.value;
                const phone = phoneInput.value;
                const email = emailInput.value;
                const area = areaSelect.value;
                const experience = experienceSelect.value;
                const message = messageInput ? messageInput.value : '';

                // Verificar CV
                const cvFile = cvInput.files[0];
                if (!cvFile) {
                    alert('Por favor adjunte su CV.');
                    return;
                }

                // Crear mensaje para WhatsApp
                let whatsappMessage = `*Nueva aplicación laboral CEMAPO*\n\n`;
                whatsappMessage += `*Nombre:* ${fullName}\n`;
                whatsappMessage += `*Ciudad:* ${city}\n`;
                whatsappMessage += `*Teléfono:* ${phone}\n`;
                whatsappMessage += `*Email:* ${email}\n`;
                whatsappMessage += `*Área de interés:* ${area}\n`;
                whatsappMessage += `*Experiencia:* ${experience}\n`;

                if (message) {
                    whatsappMessage += `*Mensaje:* ${message}\n`;
                }

                whatsappMessage += `\n*Nota:* Por favor enviar CV como archivo adjunto por WhatsApp o al correo seleccion@cemapoedu.ec`;

                // Codificar para URL
                const encodedMessage = encodeURIComponent(whatsappMessage);

                // Abrir WhatsApp
                window.open(`https://wa.me/593982121145?text=${encodedMessage}`, '_blank');
            });
        }

        // Configurar envío por Email
        if (genMailtoBtn) {
            genMailtoBtn.addEventListener('click', function(e) {
                e.preventDefault();

                if (!generalApplicationForm.checkValidity()) {
                    generalApplicationForm.reportValidity();
                    return;
                }

                const fullName = fullNameInput.value;
                const area = areaSelect.value;

                // Crear enlace mailto
                const mailtoLink = `mailto:seleccion@cemapoedu.ec?subject=Aplicación laboral: ${encodeURIComponent(area)} - ${encodeURIComponent(fullName)}&body=Por favor complete este correo con su información y adjunte su CV.`;

                // Abrir cliente de correo
                window.location.href = mailtoLink;
            });
        }

        // Manejar envío del formulario general
        generalApplicationForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            // Validar formulario
            if (!generalApplicationForm.checkValidity()) {
                generalApplicationForm.reportValidity();
                return false;
            }

            // Deshabilitar botones mientras se procesa
            genSubmitBtnSave.disabled = true;
            if (genMailtoBtn) genMailtoBtn.disabled = true;
            if (genSubmitBtnWhatsApp) genSubmitBtnWhatsApp.disabled = true;
            const originalButtonText = genSubmitBtnSave.innerHTML;
            genSubmitBtnSave.innerHTML = '<svg class="animate-spin h-5 w-5 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';

            try {
                // Crear FormData para enviar los datos y el archivo
                const formData = new FormData(generalApplicationForm);
                formData.append('isGeneral', 'true');

                // Enviar datos al endpoint con HTTPS
                const response = await fetch('https://cemapo.softlatam.com/api/submit-application', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (!response.ok || !result.success) {
                    throw new Error(result.message || 'Error al enviar la aplicación');
                }

                // Mostrar mensaje de éxito
                updateFormStatus('Aplicación enviada correctamente. ¡Gracias por tu interés!', true);

                // Limpiar formulario
                generalApplicationForm.reset();
            } catch (error) {
                console.error('Error al enviar aplicación:', error);

                // Mostrar mensaje de error y sugerir alternativas
                updateFormStatus(`Error: No se pudo enviar la aplicación. Por favor, intenta usar el botón de WhatsApp o enviar por correo electrónico.`, false);
            } finally {
                // Re-habilitar botones
                setTimeout(() => {
                    genSubmitBtnSave.disabled = false;
                    if (genMailtoBtn) genMailtoBtn.disabled = false;
                    if (genSubmitBtnWhatsApp) genSubmitBtnWhatsApp.disabled = false;
                    genSubmitBtnSave.innerHTML = originalButtonText;
                }, 2000);
            }

            return false;
        });

        // Opcional: Validaciones en tiempo real
        [fullNameInput, cityInput, phoneInput, emailInput, areaSelect, experienceSelect, cvInput].forEach(input => {
            if (input) {
                input.addEventListener('blur', function() {
                    if (!this.value && this.hasAttribute('required')) {
                        this.classList.add('border-red-500');
                    } else {
                        this.classList.remove('border-red-500');
                    }
                });

                input.addEventListener('input', function() {
                    if (this.value) {
                        this.classList.remove('border-red-500');
                    }
                });
            }
        });
    });
</script>